<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSA Fashion Costing & Planning Tool (V2.2 - Optimized)</title>
    <!-- Tailwind is used for minor utility classes only -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* KU Fonts & Base Styling */
        :root { /* Define CSS Variables */
            --ku-black: #1D1D1B;
            --ku-white: #FFFFFF;
            --ku-yellow: #FFF200;
            --ku-grey-light: #f0f0f0;
            --ku-grey-mid: #A0A0A0;
            --ku-grey-dark: #666;
            --ku-grey-table-header: #f1f1f1;
            --ku-grey-table-border: #ddd;
            --ku-blue-dark: #002b49;
            --ku-blue-mid: #005ea5;
            --ku-blue-light: #009cde;
            --ku-blue-lighter: #cfe9f7;
            --ku-orange: #e35205;
            --ku-red-error: #c53030;
            --ku-red-error-bg: #fbebeb;
            --ku-red-error-border: #f5c6cb;
            --font-main: 'Inter', Arial, sans-serif;
        }
        body { font-family: var(--font-main); background-color: var(--ku-grey-light); padding: 0; margin: 0; color: var(--ku-black); font-size: 14px; line-height: 1.6; }
        .ku-content-wrapper { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .ku-content { background-color: var(--ku-white); padding: 20px 30px 30px 30px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; }
        .header h1 { font-size: 1.75rem; font-weight: bold; margin-bottom: 1rem; color: var(--ku-blue-dark); }
        .footer { text-align: center; margin-top: 30px; padding: 20px; color: var(--ku-grey-dark); font-size: 0.9rem; border-top: 1px solid #eee; }

        /* KU Navigation & Action Buttons Styling */
        nav#main-nav, .action-buttons { background-color: var(--ku-blue-dark); padding: 8px 5px; margin-bottom: 25px; text-align: center; border-radius: 3px; }
        nav#main-nav button, .action-buttons button, .ku-button { display: inline-block; background-color: var(--ku-yellow); color: var(--ku-black); font-weight: bold; font-size: 0.95rem; padding: 8px 15px; border-radius: 0; text-decoration: none; margin: 4px 5px; border: 1px solid var(--ku-black); cursor: pointer; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s; }
        .action-buttons button, .ku-button { font-size: 1rem; padding: 10px 18px; } /* Standard button slightly larger */
        nav#main-nav button:hover, .action-buttons button:hover, .ku-button:hover { background-color: #e8de00; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav#main-nav button.active { background-color: var(--ku-orange); color: var(--ku-white); border-color: var(--ku-orange); }
        .ku-button-secondary { background-color: var(--ku-grey-table-header); color: var(--ku-black); border-color: var(--ku-grey-mid); }
        .ku-button-secondary:hover { background-color: #e0e0e0; }
        .delete-button { background-color: var(--ku-red-error-bg); color: var(--ku-red-error); border: 1px solid var(--ku-red-error-border); font-size: 0.8rem; padding: 3px 6px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
        .delete-button:hover { background-color: #f8d7da; color: #721c24; }

        /* Page Sections & General Form Styling */
        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-section, .table-section, .info-section { margin-bottom: 25px; padding: 20px; border: 1px solid var(--ku-grey-table-border); background-color: var(--ku-white); }
        .form-section h3, .table-section h3, .info-section h3 { font-size: 1.25rem; font-weight: bold; margin-top: 0; margin-bottom: 15px; color: var(--ku-blue-dark); padding-bottom: 8px; border-bottom: 2px solid var(--ku-blue-light); }
        h2 { font-size: 1.5rem; font-weight: bold; color: var(--ku-blue-dark); margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input[type="text"], input[type="number"], select { display: block; width: 100%; max-width: 350px; padding: 8px 10px; margin-bottom: 3px; border: 1px solid var(--ku-grey-mid); border-radius: 0; background-color: var(--ku-yellow); font-size: 1rem; }
        input[type="number"] { max-width: 120px; }
        select { background-color: var(--ku-white); max-width: 400px; width: auto; }
        input:focus, select:focus { outline: 2px solid var(--ku-blue-light); outline-offset: 1px; }
        .input-group { margin-bottom: 12px; }
        .error-message { color: var(--ku-red-error); font-size: 0.8rem; margin-top: 1px; height: 1.1em; display: block; }

        /* KU Canvas Table Styling */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background-color: var(--ku-grey-table-header); text-align: left; padding: 12px; border: 1px solid var(--ku-grey-table-border); font-weight: bold; font-size: 0.9rem; color: var(--ku-black); }
        td { padding: 10px 12px; border: 1px solid var(--ku-grey-table-border); vertical-align: middle; font-size: 0.95rem; }
        caption { text-align: left; font-weight: bold; font-size: 1.1rem; color: var(--ku-blue-dark); margin-bottom: 10px; }
        .bom-table input[type="number"], .bom-table select { width: 90%; max-width: none; padding: 6px 8px; font-size: 0.9rem; margin-bottom: 0; display: inline-block; }
        .bom-table select { width: auto; min-width: 140px; }
        .bom-table td { padding: 4px 6px; vertical-align: top; }

        /* Output Field Styling */
        .output-field { font-weight: bold; color: var(--ku-blue-dark); display: inline-block; min-width: 65px; text-align: right; padding: 4px 8px; background-color: var(--ku-grey-table-header); border-radius: 0; border: 1px solid var(--ku-grey-table-border); margin-left: 5px; }
        .form-section .output-field { margin-bottom: 12px; }
        .currency::before { content: '£'; margin-right: 2px; }
        .usd::after { content: ' USD'; margin-left: 2px; }
        .percentage::after { content: '%'; margin-left: 2px; }
        .subtotal-row td { font-weight: bold; background-color: #e9ecef; }
        .grand-total-row td, .grand-total-row { font-weight: bold; font-size: 1.1em; background-color: var(--ku-blue-lighter); border: 1px solid #a0cce3; padding: 10px 15px; }
        .grand-total-row label { font-size: 1em; display: inline-block; margin-right: 10px; margin-bottom: 0; }

        /* Dashboard Styling */
        #dashboard .metric-card { background-color: var(--ku-white); padding: 15px; border-radius: 0; margin-bottom: 10px; border: 1px solid var(--ku-grey-table-border); border-left: 5px solid var(--ku-blue-light); }
        #dashboard .metric-card h4 { margin: 0 0 5px 0; font-size: 0.9rem; font-weight: bold; color: var(--ku-blue-dark); }
        #dashboard .metric-value { font-size: 1.6em; font-weight: bold; color: var(--ku-black); display: block; margin-bottom: 3px; }
        #dashboard .metric-details { font-size: 0.85em; color: var(--ku-grey-dark); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }

        /* Tooltip Styling */
        .tooltip { position: relative; display: inline-block; cursor: help; border-bottom: 1px dashed #777; margin-left: 5px; color: var(--ku-blue-mid); }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: var(--ku-black); color: var(--ku-white); text-align: center; border-radius: 4px; padding: 8px 10px; position: absolute; z-index: 1; bottom: 130%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.85rem; font-weight: normal; line-height: 1.4; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--ku-black) transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Modal Styling */
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 50; padding: 20px; overflow-y: auto; }
        .modal-content { background-color: var(--ku-white); padding: 25px 30px; border-radius: 0; max-width: 800px; margin: 40px auto; position: relative; animation: modalOpen 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--ku-grey-table-border); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.4rem; color: var(--ku-blue-dark); }
        .modal-close-button { background: none; border: none; font-size: 2rem; font-weight: bold; line-height: 1; color: #888; cursor: pointer; padding: 0 5px; }
        .modal-close-button:hover { color: var(--ku-black); }
        @keyframes modalOpen { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

         /* Print Specific Styles */
         @media print {
             body { background-color: #fff; font-size: 10pt; color: #000;}
             :root { /* Ensure black/white for print */
                --ku-black: #000000; --ku-white: #FFFFFF;
                --ku-blue-dark: #000000; --ku-blue-mid: #000000; --ku-blue-light: #000000;
             }
             .ku-content-wrapper { max-width: 100%; margin: 0; padding: 0; }
             .ku-content { box-shadow: none; border: none; padding: 0; }
             .header, nav#main-nav, .action-buttons, .footer, .modal-close-button, .ku-button, .tooltip, .error-message, .delete-button, #saveLoadStatus, .calculation-paused-indicator { display: none !important; }
             .page { display: none !important; } /* Hide pages by default */
             #report-modal { display: block !important; position: static !important; inset: auto; background: none !important; padding: 0 !important; overflow: visible !important; }
             #report-modal .modal-content { max-width: 100%; margin: 0; padding: 0; box-shadow: none; border: none !important; max-height: none; }
             #report-modal .modal-header h3 { font-size: 14pt; color: #000; }
             #report-modal .modal-header { border-bottom: 1px solid #000; }
             #report-modal .info-section, #report-modal .table-section { border: 1px solid #ccc; margin-bottom: 15px; padding: 10px; page-break-inside: avoid; }
             #report-modal table { font-size: 9pt; color: #000; }
             #report-modal th { background-color: #eee; color: #000; font-weight: bold; }
             #report-modal td { padding: 5px; border-color: #ccc; color: #000; }
             #report-modal .currency::before { content: '£'; }
             #report-modal .usd::after { content: ' USD'; }
             #report-modal .percentage::after { content: '%'; }
             h1 { font-size: 16pt; } h2 { font-size: 14pt; margin-bottom: 10px; } h3 { font-size: 12pt; border-color: #000; }
             .modal-body table th:last-child, .modal-body table td:last-child { display: none; } /* Hide actions column in print */
         }
         .calculation-paused-indicator { display: none; color: var(--ku-red-error); font-weight: bold; margin: 10px 0; padding: 10px; background-color: var(--ku-red-error-bg); border: 1px solid var(--ku-red-error-border); text-align: center; border-radius: 3px; }
         body.calculation-paused .calculation-paused-indicator { display: block; }
         body.calculation-paused .output-field { background-color: #f8d7da; } /* Indicate stale data */
         body.calculation-paused nav#main-nav button:not(.active) { opacity: 0.7; pointer-events: none; } /* Dim inactive buttons */

    </style>
</head>
<body > <!-- Calculation paused class added dynamically -->

    <div class="ku-content-wrapper">
        <!-- Header -->
        <div class="header">
            <h1>KSA Fashion Costing & Planning Tool (V2.2)</h1>
            <p class="text-base text-gray-700 max-w-3xl mx-auto">Enhanced interactive tool with Save/Load, Validation & Reporting features.</p>
             <div class="action-buttons" style="background: none; text-align:center; padding: 10px 0;">
                 <button id="saveButton" class="ku-button ku-button-secondary">Save Progress</button>
                 <button id="loadButton" class="ku-button ku-button-secondary">Load Progress</button>
                 <span id="saveLoadStatus" style="margin-left: 10px; font-size: 0.85em; color: green;"></span>
             </div>
        </div>

        <div class="ku-content">
             <!-- Navigation -->
            <nav id="main-nav">
                 <button onclick="showPage('dashboard')" class="active">Dashboard</button>
                 <button onclick="showPage('product-info')">1.Product Info</button>
                 <button onclick="showPage('bom')">2.BOM</button>
                 <button onclick="showPage('labour-processes')">3.Labour & Process</button>
                 <button onclick="showPage('factory-costs')">4.Factory Costs (FOB)</button>
                 <button onclick="showPage('logistics-import')">5.Logistics & Import (LCP)</button>
                 <button onclick="showPage('pricing-retail')">6.Pricing & Retail</button>
                 <button onclick="showPage('sustainability')">7.Sustainability</button>
                 <button onclick="showPage('business-analysis')">8.Business Analysis</button>
                  <button onclick="openModal('report-modal')" class="ku-button-secondary" id="viewReportButton">View Report</button>
                 <button onclick="openModal('instructions-modal')" class="ku-button-secondary">Instructions</button>
             </nav>

            <div class="calculation-paused-indicator" id="calcPausedIndicator">
                 Calculation paused due to input errors (marked in red). Please correct before proceeding or viewing report. Output values may be inaccurate.
            </div>

             <!-- === ALL PAGE SECTIONS === -->
             <!-- (Identical HTML structure for pages Dashboard to Business Analysis as previous version with -error spans added) -->

              <!-- == DASHBOARD == -->
              <div id="dashboard" class="page active">
                  <h2>Dashboard Overview</h2>
                   <p class="mb-6 text-gray-600">Summary of key metrics. Use Sections 1-8 in the navigation to enter data.</p>
                  <!-- Dashboard Grid Content -->
                  <div class="dashboard-grid"> <div class="metric-card"> <h4>Product Name</h4> <span class="metric-value" id="dash-product-name">--</span> </div> <div class="metric-card"> <h4>Target Retail Price</h4> <span class="metric-value currency" id="dash-target-retail">0.00</span> </div> <div class="metric-card"> <h4>Final Retail Price</h4> <span class="metric-value currency" id="dash-calc-retail">0.00</span> <div class="metric-details">(Incl. VAT)</div> </div> <div class="metric-card"> <h4>Landed Cost Price (LCP)</h4> <span class="metric-value currency" id="dash-lcp">0.00</span> </div> <div class="metric-card"> <h4>FOB Price</h4> <span class="metric-value currency" id="dash-fob">0.00</span> <div class="metric-details">(UK £ Equivalent)</div> </div> <div class="metric-card"> <h4>Material Cost</h4> <span class="metric-value currency" id="dash-material-cost">0.00</span> <div class="metric-details"><span id="dash-material-perc" class="percentage">0</span> of FOB</div> </div> <div class="metric-card"> <h4>Labour Cost</h4> <span class="metric-value currency" id="dash-labour-cost">0.00</span> <div class="metric-details"><span id="dash-labour-perc" class="percentage">0</span> of FOB</div> </div> <div class="metric-card"> <h4>Retail Margin</h4> <span class="metric-value percentage" id="dash-margin">0.00</span> <div class="metric-details">(On Chosen Retail Excl. VAT)</div> </div> <div class="metric-card"> <h4>Sustainability Score</h4> <span class="metric-value" id="dash-sustainability">0</span> / 5 </div> <div class="metric-card"> <h4>Break-Even Units</h4> <span class="metric-value" id="dash-break-even">0</span> <div class="metric-details">(Units per month)</div> </div> </div>
                  <div class="info-section">
                      <h3>FOB Price Cost Breakdown (Estimate %)</h3>
                       <p> Materials: <span class="output-field percentage" id="dash-breakdown-material">0.0</span> | Labour: <span class="output-field percentage" id="dash-breakdown-labour">0.0</span> | Processes: <span class="output-field percentage" id="dash-breakdown-process">0.0</span> | Overheads: <span class="output-field percentage" id="dash-breakdown-overhead">0.0</span> | Profit: <span class="output-field percentage" id="dash-breakdown-profit">0.0</span> | Commission: <span class="output-field percentage" id="dash-breakdown-commission">0.0</span> | Rejects: <span class="output-field percentage" id="dash-breakdown-rejects">0.0</span> </p>
                 </div>
                  <p class="text-sm text-gray-500 mt-4"><em>Note: Remember to 'Save Progress' frequently. This data is stored only in your current browser.</em></p>
             </div>

             <!-- == PRODUCT INFO == -->
             <div id="product-info" class="page"> <h2>1. Product Information</h2> <div class="form-section"> <h3>Product Details</h3> <div class="input-group"> <label for="product-name">Product Name:</label> <input type="text" id="product-name" value="Chambray Shirt"> <span class="error-message"></span> </div> <div class="input-group"> <label for="season">Season/Collection:</label> <input type="text" id="season" value="SS24"> <span class="error-message"></span> </div> <div class="input-group"> <label for="designer">Designer/Brand:</label> <input type="text" id="designer" value="Sustainable MA Project"> <span class="error-message"></span> </div> <div class="input-group"> <label for="category">Product Category:</label> <input type="text" id="category" value="Woven Shirt"> <span class="error-message"></span> </div> <div class="input-group"> <label for="target-customer">Target Customer:</label> <input type="text" id="target-customer" value="Likes quality essentials (Reiss, L'Estrange)"> <span class="error-message"></span> </div> <div class="input-group"> <label for="target-quantity">Target Order Quantity (Units):</label> <input type="number" id="target-quantity" value="740" min="0"> <span class="error-message" id="target-quantity-error"></span> </div> <div class="input-group"> <label for="target-retail-price">Target Retail Price (£ inc VAT):</label> <input type="number" id="target-retail-price" value="89.99" step="0.01" min="0"> <span class="error-message" id="target-retail-price-error"></span> </div> </div> </div>

            <!-- == BOM == -->
            <div id="bom" class="page"> <h2>2. Bill of Materials (BOM)</h2> <div class="table-section"> <h3>Materials Costing</h3> <p class="text-sm mb-3 text-gray-600">Select materials, enter Net Usage per garment & Waste %. Prices assumed in Factory Currency (USD for demo). Add/delete rows as needed.</p> <div class="overflow-x-auto"> <table class="bom-table min-w-[950px]"> <thead> <tr> <th class="w-1/6">Material ID</th> <th>Description</th> <th>Net Usage</th> <th>Unit</th> <th>Waste %</th> <th>Gross Usage</th> <th>Price/Unit (USD)</th> <th>Cost/Gmt (USD)</th> <th>Sust. Score (1-5)</th> <th class="w-[50px]">Actions</th> </tr> </thead> <tbody id="bom-items"></tbody> <tfoot> <tr class="grand-total-row"> <td colspan="7" style="text-align:right;">TOTAL Material Cost / Garment:</td> <td id="total-material-cost" class="usd">0.00</td> <td></td><td></td> </tr> </tfoot> </table> </div> <button class="ku-button mt-4" onclick="addBomRow()">+ Add Material Row</button> </div> </div>

             <!-- == LABOUR & PROCESSES == -->
            <div id="labour-processes" class="page"> <h2>3. Labour & Processes</h2> <p class="text-sm mb-3 text-gray-600">Enter estimated times and costs in UK £.</p> <div class="table-section"> <h3>Manufacturing Labour (£)</h3> <table id="labour-table"> <thead><tr><th>Activity</th><th>Time/Unit (Mins)</th><th>Labour Rate (£/Hour)</th><th>Cost/Unit (£)</th></tr></thead> <tbody> <tr><td>Cutting</td> <td><div class="input-group"><input type="number" id="labour-cut-time" value="60" step="1" min="0" oninput="calculateAll()"><span id="labour-cut-time-error" class="error-message"></span></div></td> <td><div class="input-group"><input type="number" id="labour-cut-rate" value="12.00" step="0.01" min="0" oninput="calculateAll()"><span id="labour-cut-rate-error" class="error-message"></span></div></td> <td><span class="output-field currency" id="labour-cut-cost">0.00</span></td></tr> <tr><td>Sewing/Make</td> <td><div class="input-group"><input type="number" id="labour-sew-time" value="180" step="1" min="0" oninput="calculateAll()"><span id="labour-sew-time-error" class="error-message"></span></div></td> <td><div class="input-group"><input type="number" id="labour-sew-rate" value="11.50" step="0.01" min="0" oninput="calculateAll()"><span id="labour-sew-rate-error" class="error-message"></span></div></td> <td><span class="output-field currency" id="labour-sew-cost">0.00</span></td></tr> <tr><td>Finishing (inc. Pressing, QC)</td> <td><div class="input-group"><input type="number" id="labour-finish-time" value="60" step="1" min="0" oninput="calculateAll()"><span id="labour-finish-time-error" class="error-message"></span></div></td> <td><div class="input-group"><input type="number" id="labour-finish-rate" value="11.00" step="0.01" min="0" oninput="calculateAll()"><span id="labour-finish-rate-error" class="error-message"></span></div></td> <td><span class="output-field currency" id="labour-finish-cost">0.00</span></td></tr> <tr><td>Buttoning (if separate)</td> <td><div class="input-group"><input type="number" id="labour-button-time" value="6" step="1" min="0" oninput="calculateAll()"><span id="labour-button-time-error" class="error-message"></span></div></td> <td><div class="input-group"><input type="number" id="labour-button-rate" value="10.00" step="0.01" min="0" oninput="calculateAll()"><span id="labour-button-rate-error" class="error-message"></span></div></td> <td><span class="output-field currency" id="labour-button-cost">0.00</span></td></tr></tbody> <tfoot> <tr class="subtotal-row"> <td colspan="3" style="text-align:right;">Total Labour Cost/Unit (£):</td><td><span class="output-field currency" id="total-labour-cost">0.00</span></td></tr></tfoot></table></div><div class="table-section"><h3>Manufacturing Processes (£)</h3><table id="process-table"><thead><tr><th>Process</th><th>Cost/Unit (£)</th></tr></thead><tbody><tr><td>Garment Wash</td><td><div class="input-group"><input type="number" id="process-wash-cost" value="0.35" step="0.01" min="0" oninput="calculateAll()"><span id="process-wash-cost-error" class="error-message"></span></div></td></tr><tr><td>Embroidery / Print</td><td><div class="input-group"><input type="number" id="process-embroidery-cost" value="0.00" step="0.01" min="0" oninput="calculateAll()"><span id="process-embroidery-cost-error" class="error-message"></span></div></td></tr></tbody><tfoot><tr class="subtotal-row"><td style="text-align:right;">Total Process Cost/Unit (£):</td><td><span class="output-field currency" id="total-process-cost">0.00</span></td></tr></tfoot></table></div> <div class="form-section grand-total-row"><label>Total Labour & Process Cost/Unit (£):</label><span class="output-field currency" id="total-labour-process-cost">0.00</span></div> </div>

            <!-- == FACTORY COSTS == -->
             <div id="factory-costs" class="page"> <h2>4. Factory Costs & FOB Price</h2> <p class="text-sm mb-3 text-gray-600">Calculates cost up to 'Free On Board'. Assumed calculation in Factory Currency (USD for demo).</p> <div class="form-section"> <h3>Cost of Production (CoP) (USD)</h3> <div class="input-group"><label>Total Material Cost:</label><span class="output-field usd" id="fc-material-cost">0.00</span></div> <div class="input-group"><label>Total Labour Cost (£ equivalent used):</label><span class="output-field usd" id="fc-labour-cost">0.00</span><span class="tooltip">?<span class="tooltiptext">Demo assumes £ Labour cost equals the Factory Currency cost value.</span></span></div> <div class="input-group"><label>Total Process Cost (£ equivalent used):</label><span class="output-field usd" id="fc-process-cost">0.00</span></div> <div class="input-group"> <label for="factory-overhead-perc">Factory Overheads %:</label> <input type="number" id="factory-overhead-perc" value="100" step="1" min="0" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Applied to Labour Cost only in this calculation.</span></span> <span id="factory-overhead-perc-error" class="error-message"></span> <div class="mt-2">Calculated Overheads Value: <span class="output-field usd" id="fc-overhead-value">0.00</span></div> </div> <div class="input-group mt-4"><label style="font-weight:bold; font-size:1.1em;">Cost of Production (CoP):</label><span class="output-field usd" id="fc-cop" style="font-weight:bold; font-size:1.1em;">0.00</span></div> </div> <div class="form-section"> <h3>Factory Margin & FOB Price (USD)</h3> <div class="input-group"> <label for="factory-rejects-perc">Seconds / Rejects %:</label> <input type="number" id="factory-rejects-perc" value="2" step="0.1" min="0" max="100" oninput="calculateAll()"> <span class="output-field percentage"></span> <span id="factory-rejects-perc-error" class="error-message"></span> <div class="mt-2">Rejects Value (on CoP): <span class="output-field usd" id="fc-rejects-value">0.00</span></div> </div> <div class="input-group"> <label for="factory-profit-perc">Manufacturer's Profit %:</label> <input type="number" id="factory-profit-perc" value="25.55" step="0.01" min="0" max="99.99" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Calculated ON Selling Price (FOB).</span></span> <span id="factory-profit-perc-error" class="error-message"></span> <div class="mt-2">Calculated Profit Value: <span class="output-field usd" id="fc-profit-value">0.00</span></div> </div> <div class="input-group"> <label for="factory-commission-perc">Commission % (Agent etc.):</label> <input type="number" id="factory-commission-perc" value="12" step="0.1" min="0" max="99.99" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Also calculated ON Selling Price (FOB). Profit+Commission must be less than 100%.</span></span> <span id="factory-commission-perc-error" class="error-message"></span> <div class="mt-2">Calculated Commission Value: <span class="output-field usd" id="fc-commission-value">0.00</span></div> </div> <div class="grand-total-row mt-4 p-4"> <label>Calculated Ex-Factory / FOB Price / Unit (USD):</label> <span class="output-field usd" id="fc-fob-price">0.00</span> <span class="tooltip">?<span class="tooltiptext">FOB = (CoP + Rejects Value) / (1 - Profit % - Commission %)</span></span> </div> </div> </div>

            <!-- == LOGISTICS & IMPORT == -->
             <div id="logistics-import" class="page"> <h2>5. Logistics & Import (Landed Cost Price - LCP)</h2> <p class="text-sm mb-3 text-gray-600">Calculate total cost (£) to get goods into UK warehouse. Enter costs in USD.</p> <div class="form-section"> <h3>Costs from FOB to Landed (Enter in USD)</h3> <div class="input-group"><label>FOB Price / Unit (USD):</label><span class="output-field usd" id="li-fob-price">0.00</span></div> <div class="input-group"> <label for="li-shipping-cost">Shipping Cost / Unit (USD):</label> <input type="number" id="li-shipping-cost" value="0.20" step="0.01" min="0" oninput="calculateAll()"><span id="li-shipping-cost-error" class="error-message"></span></div> <div class="input-group"> <label for="li-insurance-cost">Insurance Cost / Unit (USD):</label> <input type="number" id="li-insurance-cost" value="0.05" step="0.01" min="0" oninput="calculateAll()"><span id="li-insurance-cost-error" class="error-message"></span></div> <div class="input-group"><label style="font-weight: bold;">CIF Price (Calculated USD):</label><span class="output-field usd" id="li-cif-price">0.00</span></div> <div class="input-group"> <label for="li-import-duty-perc">Import Duty %:</label> <input type="number" id="li-import-duty-perc" value="12" step="0.1" min="0" max="100" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Typically on CIF or FOB value. Calculated on FOB here. Check regulations!</span></span> <span id="li-import-duty-perc-error" class="error-message"></span> <div class="mt-2">Import Duty Value (USD): <span class="output-field usd" id="li-duty-value">0.00</span></div> </div> <div class="input-group"> <label for="li-clearance-cost">Customs Clearance & Fees / Unit (USD):</label> <input type="number" id="li-clearance-cost" value="0.42" step="0.01" min="0" oninput="calculateAll()"><span id="li-clearance-cost-error" class="error-message"></span></div> <div class="input-group"> <label for="li-transport-cost">UK Transport & Handling / Unit (USD Equiv.):</label> <input type="number" id="li-transport-cost" value="0.70" step="0.01" min="0" oninput="calculateAll()"><span id="li-transport-cost-error" class="error-message"></span></div> <div class="input-group"> <label for="li-warehouse-admin-perc">Reprocessing / RTM / Agency %:</label> <input type="number" id="li-warehouse-admin-perc" value="8" step="0.1" min="0" max="100" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Contingency/Agent fees, % on FOB.</span></span> <span id="li-warehouse-admin-perc-error" class="error-message"></span> <div class="mt-2">Calculated Value (USD): <span class="output-field usd" id="li-warehouse-admin-value">0.00</span></div> </div> <div class="input-group mt-4"><label style="font-weight:bold;">Total Cost Before Conversion (USD):</label><span class="output-field usd" id="li-total-pre-conversion">0.00</span></div> </div> <div class="form-section"> <h3>Currency Conversion to GBP (£)</h3> <div class="input-group"> <label for="exchange-rate">Exchange Rate (1 GBP = X USD):</label> <input type="number" id="exchange-rate" value="1.25" step="0.001" min="0.001" oninput="calculateAll()"> <span class="tooltip">?<span class="tooltiptext">How many USD equals 1 GBP. Check current rates!</span></span> <span id="exchange-rate-error" class="error-message"></span> </div> <div class="grand-total-row p-4"> <label>Landed Cost Price (LCP) / Unit (£):</label> <span class="output-field currency" id="li-lcp-gbp">0.00</span> </div> </div> </div>

             <!-- == PRICING & RETAIL == -->
            <div id="pricing-retail" class="page"> <h2>6. Pricing & Retail (£)</h2> <p class="text-sm mb-3 text-gray-600">Determine final UK selling price.</p> <div class="form-section"> <h3>Retail Price Calculation (£)</h3> <div class="input-group"><label>Landed Cost Price (LCP) / Unit:</label><span class="output-field currency" id="pr-lcp">0.00</span></div> <div class="input-group"> <label for="pr-retail-margin-perc">Target Retail Margin %:</label> <input type="number" id="pr-retail-margin-perc" value="65" step="1" min="0" max="99.99" oninput="calculateAll()"> <span class="output-field percentage"></span> <span class="tooltip">?<span class="tooltiptext">Standard Retail Margin = (Retail Price Excl. VAT - LCP) / Retail Price Excl. VAT</span></span> <span id="pr-retail-margin-perc-error" class="error-message"></span> <div class="mt-2">Calc. Retail Price (Excl. VAT): <span class="output-field currency" id="pr-calc-retail-ex-vat">0.00</span></div> </div> <div class="input-group"> <label for="pr-chosen-retail-ex-vat">Chosen Retail Price (Excl. VAT) (£):</label> <input type="number" id="pr-chosen-retail-ex-vat" value="74.99" step="0.01" min="0" oninput="calculateAll()"> <span class="tooltip">?<span class="tooltiptext">Your final price before VAT (allows e.g., £X.99 pricing).</span></span> <span id="pr-chosen-retail-ex-vat-error" class="error-message"></span> </div> <div class="input-group"> <label for="pr-vat-perc">VAT % (UK Standard):</label> <input type="number" id="pr-vat-perc" value="20" step="1" min="0" max="100" oninput="calculateAll()"> <span class="output-field percentage"></span> <span id="pr-vat-perc-error" class="error-message"></span> <div class="mt-2">VAT Amount: <span class="output-field currency" id="pr-vat-amount">0.00</span></div> </div> <div class="grand-total-row p-4"> <label>Final Retail Price (Incl. VAT) (£):</label> <span class="output-field currency" id="pr-final-retail-inc-vat">0.00</span> </div> </div> <div class="form-section"> <h3>Margin Analysis (Based on Your Chosen Price)</h3> <div class="input-group"><label>Achieved Retail Markup %:</label><span class="output-field percentage" id="pr-calc-markup">0.0</span><span class="tooltip">?<span class="tooltiptext">Markup % = (Chosen Retail Ex VAT - LCP) / LCP</span></span></div> <div class="input-group"><label>Achieved Retail Margin %:</label><span class="output-field percentage" id="pr-calc-margin">0.0</span><span class="tooltip">?<span class="tooltiptext">Margin % = (Chosen Retail Ex VAT - LCP) / Chosen Retail Ex VAT</span></span></div> </div> </div>

            <!-- == SUSTAINABILITY == -->
            <div id="sustainability" class="page"> <h2>7. Sustainability Scorecard</h2> <p class="text-sm mb-3 text-gray-600">Assess ethical & environmental factors (Approx. 1=Low, 5=High).</p> <div class="form-section"> <h3>Score Breakdown</h3> <div class="input-group"><label>Materials Score (Calculated):</label><span class="output-field" id="sus-material-score">0.0</span> / 5<span class="tooltip">?<span class="tooltiptext">Weighted avg. based on BOM material scores & cost.</span></span></div> <div class="input-group"> <label for="sus-factory-ethics">Factory Ethics Score:</label> <select id="sus-factory-ethics" onchange="calculateAll()"> <option value="1">1 - Poor / Unknown</option> <option value="2">2 - Basic Compliance</option> <option value="3" selected>3 - Audited / Fair</option> <option value="4">4 - Good Certs</option> <option value="5">5 - Excellent / Leader</option> </select> <span class="error-message"></span> </div> <div class="input-group"> <label for="sus-labour-wage">Labour Wage Context:</label> <select id="sus-labour-wage" onchange="calculateAll()"> <option value="1">1 - Below Minimum</option> <option value="2">2 - Legal Minimum Wage</option> <option value="3" selected>3 - Above Minimum</option> <option value="4">4 - Calculated Living Wage</option> <option value="5">5 - Living Wage+</option> </select> <span class="error-message"></span> </div> <div class="input-group"> <label for="sus-process-impact">Process Impact Score:</label> <select id="sus-process-impact" onchange="calculateAll()"> <option value="1">1 - High Impact</option> <option value="2">2 - Standard Wet Process</option> <option value="3" selected>3 - Reduced Impact</option> <option value="4">4 - Low Impact (Bluesign etc)</option> <option value="5">5 - Minimal / Natural</option> </select> <span class="error-message"></span> </div> <div class="input-group"> <label for="sus-logistics-impact">Logistics Impact Score:</label> <select id="sus-logistics-impact" onchange="calculateAll()"> <option value="1">1 - Air Freight Long</option> <option value="2">2 - Air Freight Short</option> <option value="3">3 - Sea Freight Long</option> <option value="4" selected>4 - Sea / Road Medium</option> <option value="5">5 - Road Short / Rail</option> </select> <span class="error-message"></span> </div> <div class="input-group"> <label for="sus-circularity">Circularity/Waste Score:</label> <select id="sus-circularity" onchange="calculateAll()"> <option value="1">1 - High Waste / Virgin</option> <option value="2">2 - Some Recycled / Reduced Waste</option> <option value="3" selected>3 - Significant Recycled / Low Waste Pattn.</option> <option value="4">4 - Durable / Repairable / High Recycled</option> <option value="5">5 - Fully Circular Design</option> </select> <span class="error-message"></span> </div> <div class="grand-total-row p-4"> <label>Overall Sustainability Score:</label> <span class="output-field" id="sus-overall-score">0.0</span> / 5 </div> </div> </div>

            <!-- == BUSINESS ANALYSIS == -->
             <div id="business-analysis" class="page"> <h2>8. Business Analysis</h2> <p class="text-sm mb-3 text-gray-600">Simple break-even based on costs & chosen retail price.</p> <div class="form-section"> <h3>Break-Even Analysis</h3> <div class="input-group"><label>Variable Cost per Unit (LCP £):</label><span class="output-field currency" id="ba-lcp">0.00</span></div> <div class="input-group"><label>Selling Price per Unit (Retail Excl. VAT £):</label><span class="output-field currency" id="ba-retail-ex-vat">0.00</span></div> <div class="input-group mt-2"><label style="font-weight: bold;">Contribution Margin per Unit (£):</label><span class="output-field currency" id="ba-contribution-margin" style="font-weight:bold;">0.00</span></div> <div class="input-group mt-4"> <label for="ba-fixed-costs">Estimated Monthly Fixed Costs (£):</label> <input type="number" id="ba-fixed-costs" value="1500" step="10" min="0" oninput="calculateAll()"> <span class="tooltip">?<span class="tooltiptext">Approximate monthly overheads (marketing, rent, software etc) required to support selling this.</span></span> <span id="ba-fixed-costs-error" class="error-message"></span> </div> <div class="grand-total-row p-4 mt-4"> <label>Break-Even Point (Units per Month):</label> <span class="output-field" id="ba-break-even-units">0</span> Units<br> <label class="mt-2">Break-Even Point (Revenue per Month £):</label> <span class="output-field currency" id="ba-break-even-revenue">0.00</span> </div> <p class="text-xs mt-3 text-gray-500">Break-even is where Total Revenue equals Total Costs (Fixed + Variable).</p> </div> </div>


             <!-- == MODALS (Report and Instructions) == -->
            <div id="instructions-modal" class="modal"> <div class="modal-content"> <div class="modal-header"><h3>Instructions & Glossary</h3><button class="modal-close-button" onclick="closeModal('instructions-modal')">×</button></div> <div class="modal-body"> <div class="info-section"><h4>How to Use</h4><ol class="list-decimal pl-5 space-y-2"><li>Start with **1. Product Info**.</li><li>Go to **2. BOM**, select materials, enter Net Usage & Waste %. Add/delete rows.</li><li>Complete **3. Labour & Processes** (£).</li><li>Review **4. Factory Costs (FOB)**. Set overheads, profit etc. FOB (USD) is calculated.</li><li>Go to **5. Logistics & Import (LCP)**. Add costs (USD), set exchange rate. LCP (£) is calculated.</li><li>In **6. Pricing & Retail**, set target margin%, choose final Retail Price (excl VAT).</li><li>Complete **7. Sustainability** scorecard.</li><li>Add Fixed Costs in **8. Business Analysis** for break-even.</li><li>The **Dashboard** shows summaries.</li><li class="font-bold text-red-600">Use **Save Progress** often! Data is only stored in *this* browser.</li><li>Use **View Report** for summary/printing.</li></ol></div><div class="info-section"><h4>Glossary</h4><dl><dt class="font-bold">BOM</dt><dd class="mb-2">Bill of Materials: List of materials.</dd><dt class="font-bold">FOB</dt><dd class="mb-2">Free On Board: Price up to loading ship at origin.</dd><dt class="font-bold">CIF</dt><dd class="mb-2">Cost, Insurance, Freight: Includes cost, insurance, freight to *destination port*.</dd><dt class="font-bold">LCP</dt><dd class="mb-2">Landed Cost Price: Total cost to get product into *your* warehouse (£).</dd><dt class="font-bold">Margin (%)</dt><dd class="mb-2">(Retail Ex VAT - LCP) / Retail Ex VAT.</dd><dt class="font-bold">Markup (%)</dt><dd class="mb-2">(Retail Ex VAT - LCP) / LCP.</dd><dt class="font-bold">CoP</dt><dd class="mb-2">Cost of Production: Matls+Labour+Process+Overheads.</dd><dt class="font-bold">VAT</dt><dd class="mb-2">Value Added Tax (UK consumption tax).</dd></dl></div> <div class="mt-6 text-center"><button class="ku-button ku-button-secondary" onclick="closeModal('instructions-modal')">Close</button></div> </div> </div> </div>
            <div id="report-modal" class="modal"> <div class="modal-content"> <div class="modal-header"><h3>Costing Summary Report</h3><button class="modal-close-button" onclick="closeModal('report-modal')">×</button></div> <div class="modal-body" id="report-content"> <!-- Populated by generateReport() --> <div class="info-section"><h3>Product Details</h3><p id="report-product-details"></p></div> <div class="info-section"><h3>Key Costs & Prices (£)</h3><p id="report-key-prices"></p></div> <div class="info-section"><h3>FOB Cost Breakdown (%)</h3><p id="report-fob-breakdown"></p></div> <div class="table-section"><h3>Bill of Materials (USD Costs)</h3><div class="overflow-x-auto"><table id="report-bom-table" class="bom-table"><thead><tr><th>Mat.ID</th><th>Description</th><th>Net Use</th><th>Unit</th><th>Waste%</th><th>Gross Use</th><th>Price/Unit</th><th>Cost/Gmt</th><th>Sust.Scr</th></tr></thead><tbody></tbody><tfoot></tfoot></table></div></div> <div class="info-section"><h3>Sustainability Overview</h3><p id="report-sustainability"></p></div> <div class="info-section"><h3>Business Analysis</h3><p id="report-business"></p></div> </div> <div class="mt-6 text-center"><button class="ku-button" onclick="printReport()">Print Report</button><button class="ku-button ku-button-secondary" onclick="closeModal('report-modal')">Close</button></div> </div> </div>


        </div> <!-- End ku-content -->
         <!-- Footer -->
          <div class="footer">
              <p>Kingston School of Art - Fashion Costing Educational Tool (V2.2)</p>
              <p>© Kingston University</p>
          </div>
     </div> <!-- End ku-content-wrapper -->

<script>
    // --- Constants & DB ---
     const factoryCurrency = 'USD';
     const localCurrency = 'GBP';
     const localSymbol = '£';
     const SAVE_KEY = 'ksaCostingToolData_v2.2'; // Version key for storage
     const materialsDB = [ /* SAME DB AS BEFORE */ { id: 'FAB001', type: 'Fabric', description: '100% Cotton Chambray', unit: 'm', price: 4.55, currency: 'USD', sustScore: 3 }, { id: 'FAB002', type: 'Fabric', description: 'Interlining (Woven)', unit: 'm', price: 2.15, currency: 'USD', sustScore: 2 }, { id: 'FAB003', type: 'Fabric', description: 'GOTS Organic Cotton Twill', unit: 'm', price: 6.75, currency: 'USD', sustScore: 5 }, { id: 'TRM001', type: 'Trim', description: 'Coconut Buttons (15mm)', unit: '100pcs', price: 8.00, currency: 'USD', sustScore: 4 }, { id: 'TRM002', type: 'Trim', description: 'Ascolite Button Securing', unit: '1000pcs', price: 15.00, currency: 'USD', sustScore: 3 }, { id: 'TRM003', type: 'Trim', description: 'Recycled PET Buttons (15mm)', unit: '100pcs', price: 9.50, currency: 'USD', sustScore: 4 }, { id: 'LBL001', type: 'Label', description: 'Main Label (Woven Rec Poly)', unit: '500pcs', price: 65.00, currency: 'USD', sustScore: 4 }, { id: 'LBL002', type: 'Label', description: 'Size Label (Woven Rec Poly)', unit: '1000pcs', price: 40.00, currency: 'USD', sustScore: 4 }, { id: 'LBL003', type: 'Label', description: 'Care Label (Printed Rec Poly)', unit: '1000pcs', price: 40.00, currency: 'USD', sustScore: 4 }, { id: 'PKG001', type: 'Packaging', description: 'Recycled Polybag', unit: '100pcs', price: 3.50, currency: 'USD', sustScore: 3 }, { id: 'PKG002', type: 'Packaging', description: 'Recycled Card Hangtag', unit: '100pcs', price: 15.00, currency: 'USD', sustScore: 4 }, { id: 'PKG003', type: 'Packaging', description: 'Collar Stand (Card)', unit: '100pcs', price: 2.00, currency: 'USD', sustScore: 2 }, { id: 'THR001', type: 'Thread', description: 'Recycled Polyester Thread Cone', unit: 'cone', price: 3.50, currency: 'USD', sustScore: 3 }];

     // --- Global State Variables ---
     let appState = {
          totalMaterialCostUSD: 0,
          totalLabourCostGBP: 0,
          totalProcessCostGBP: 0,
          factoryCoP_USD: 0,
          factoryFOB_USD: 0,
          landedCostGBP: 0,
          retailExVatGBP: 0,
          retailIncVatGBP: 0,
          sustainabilityScore: 0,
          breakEvenUnits: 0,
          calculationPaused: false
      };

     // --- DOM Cache ---
      const domCache = {}; // Object to hold cached DOM elements
      function cacheDOMElements() { /* ... FULL cacheDOMElements function as provided in optimization answer ... */ domCache.totalMaterialCost = document.getElementById('total-material-cost'); domCache.totalLabourCost = document.getElementById('total-labour-cost'); domCache.totalProcessCost = document.getElementById('total-process-cost'); domCache.totalLabourProcessCost = document.getElementById('total-labour-process-cost'); domCache.fcMaterialCost = document.getElementById('fc-material-cost'); domCache.fcLabourCost = document.getElementById('fc-labour-cost'); domCache.fcProcessCost = document.getElementById('fc-process-cost'); domCache.fcOverheadValue = document.getElementById('fc-overhead-value'); domCache.fcCop = document.getElementById('fc-cop'); domCache.fcRejectsValue = document.getElementById('fc-rejects-value'); domCache.fcProfitValue = document.getElementById('fc-profit-value'); domCache.fcCommissionValue = document.getElementById('fc-commission-value'); domCache.fcFobPrice = document.getElementById('fc-fob-price'); domCache.liFobPrice = document.getElementById('li-fob-price'); domCache.liCifPrice = document.getElementById('li-cif-price'); domCache.liDutyValue = document.getElementById('li-duty-value'); domCache.liWarehouseAdminValue = document.getElementById('li-warehouse-admin-value'); domCache.liTotalPreConversion = document.getElementById('li-total-pre-conversion'); domCache.liLcpGbp = document.getElementById('li-lcp-gbp'); domCache.prLcp = document.getElementById('pr-lcp'); domCache.prCalcRetailExVat = document.getElementById('pr-calc-retail-ex-vat'); domCache.prVatAmount = document.getElementById('pr-vat-amount'); domCache.prFinalRetailIncVat = document.getElementById('pr-final-retail-inc-vat'); domCache.prCalcMarkup = document.getElementById('pr-calc-markup'); domCache.prCalcMargin = document.getElementById('pr-calc-margin'); domCache.susMaterialScore = document.getElementById('sus-material-score'); domCache.susOverallScore = document.getElementById('sus-overall-score'); domCache.baLcp = document.getElementById('ba-lcp'); domCache.baRetailExVat = document.getElementById('ba-retail-ex-vat'); domCache.baContributionMargin = document.getElementById('ba-contribution-margin'); domCache.baBreakEvenUnits = document.getElementById('ba-break-even-units'); domCache.baBreakEvenRevenue = document.getElementById('ba-break-even-revenue'); domCache.dashProductName = document.getElementById('dash-product-name'); domCache.dashTargetRetail = document.getElementById('dash-target-retail'); domCache.dashCalcRetail = document.getElementById('dash-calc-retail'); domCache.dashLcp = document.getElementById('dash-lcp'); domCache.dashFob = document.getElementById('dash-fob'); domCache.dashMaterialCost = document.getElementById('dash-material-cost'); domCache.dashMaterialPerc = document.getElementById('dash-material-perc'); domCache.dashLabourCost = document.getElementById('dash-labour-cost'); domCache.dashLabourPerc = document.getElementById('dash-labour-perc'); domCache.dashMargin = document.getElementById('dash-margin'); domCache.dashSustainability = document.getElementById('dash-sustainability'); domCache.dashBreakEven = document.getElementById('dash-break-even'); domCache.dashBreakdownMaterial = document.getElementById('dash-breakdown-material'); domCache.dashBreakdownLabour = document.getElementById('dash-breakdown-labour'); domCache.dashBreakdownProcess = document.getElementById('dash-breakdown-process'); domCache.dashBreakdownOverhead = document.getElementById('dash-breakdown-overhead'); domCache.dashBreakdownProfit = document.getElementById('dash-breakdown-profit'); domCache.dashBreakdownCommission = document.getElementById('dash-breakdown-commission'); domCache.dashBreakdownRejects = document.getElementById('dash-breakdown-rejects'); domCache.exchangeRateInput = document.getElementById('exchange-rate'); /* Add more as needed */ }

      // --- Helper Functions (getNumVal, getTxtVal, getSelectedVal, findMaterial, setVal, displayError, clearAllErrors) ---
       // (Include the final versions here)
       function getNumVal(id) { const el = domCache[id] || document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; } // Use cache first
       function getTxtVal(id) { const el = domCache[id] || document.getElementById(id); return el ? el.value : ''; }
       function getSelectedVal(id) { const el = domCache[id] || document.getElementById(id); if(el){ const v = el.value; return isNaN(parseFloat(v)) ? v : parseFloat(v); } return ''; }
       function findMaterial(id) { return materialsDB.find(m => m.id === id); }
       function setVal(id, value, format = null) { const el = domCache[id] || document.getElementById(id); if (!el) { /* console.warn(`setVal: Element ${id} not found`);*/ return;} let dV = ''; if (typeof value === 'number') { switch(format){ case 'currency': dV = value.toFixed(2); break; case 'percentage': dV = value.toFixed(1); break; case 'integer': dV = Math.ceil(value); break; case 'decimal1': dV = value.toFixed(1); break; case 'decimal3': dV = value.toFixed(3); break; case 'decimal4': dV = value.toFixed(4); break; default: dV = value.toFixed(2); } } else { dV = value; } if (el.tagName === 'INPUT' || el.tagName === 'SELECT') { el.value = dV; } else { el.textContent = dV; } }
       function displayError(id, message) { const errorSpan = document.getElementById(`${id}-error`) || document.querySelector(`[data-error-for="${id}"]`) || document.getElementById(id)?.closest('.input-group')?.querySelector('.error-message'); if(errorSpan) {errorSpan.textContent=message;} const inputEl = document.getElementById(id); if (inputEl) { inputEl.style.borderColor = message ? 'var(--ku-red-error)' : 'var(--ku-grey-mid)';} }
       function clearAllErrors() { document.querySelectorAll('.error-message').forEach(span => span.textContent=''); document.querySelectorAll('input, select').forEach(el => el.style.borderColor='var(--ku-grey-mid)'); appState.calculationPaused = false; document.body.classList.remove('calculation-paused'); }

       // --- Validation ---
       const validationRules = { /* SAME rules */ 'target-quantity': { min: 0 }, 'target-retail-price': { min: 0 }, 'labour-cut-time': { min: 0 }, 'labour-cut-rate': { min: 0 }, 'labour-sew-time': { min: 0 }, 'labour-sew-rate': { min: 0 }, 'labour-finish-time': { min: 0 }, 'labour-finish-rate': { min: 0 }, 'labour-button-time': { min: 0 }, 'labour-button-rate': { min: 0 }, 'process-wash-cost': { min: 0 }, 'process-embroidery-cost': { min: 0 }, 'factory-overhead-perc': { min: 0 }, 'factory-rejects-perc': { min: 0, max: 100 }, 'factory-profit-perc': { min: 0, max: 99.99 }, 'factory-commission-perc': { min: 0, max: 99.99 }, 'li-shipping-cost': { min: 0 }, 'li-insurance-cost': { min: 0 }, 'li-import-duty-perc': { min: 0, max: 100 }, 'li-clearance-cost': { min: 0 }, 'li-transport-cost': { min: 0 }, 'li-warehouse-admin-perc': { min: 0, max: 100 }, 'exchange-rate': { min: 0.001 }, 'pr-retail-margin-perc': { min: 0, max: 99.99 }, 'pr-chosen-retail-ex-vat': { min: 0 }, 'pr-vat-perc': { min: 0, max: 100 }, 'ba-fixed-costs': { min: 0 }};
       function validateInputs() { /* SAME validation logic */ clearAllErrors(); let isValid=true; for(const id in validationRules){ const el=document.getElementById(id); if(!el) continue; const val=getNumVal(id); const rule=validationRules[id]; let msg=''; if (rule.min !==undefined && val < rule.min){msg=`Min: ${rule.min}`;} else if (rule.max !==undefined && val > rule.max){msg=`Max: ${rule.max}`;} if (msg){displayError(id, msg);isValid=false;}} const pP=getNumVal('factory-profit-perc'); const cP=getNumVal('factory-commission-perc'); if(pP+cP >= 100){displayError('factory-profit-perc','Profit+Comm < 100%');displayError('factory-commission-perc','');isValid=false;} appState.calculationPaused=!isValid; document.body.classList.toggle('calculation-paused', appState.calculationPaused); document.getElementById('viewReportButton').disabled = appState.calculationPaused; return isValid; } // Disable report btn if invalid

       // --- BOM Functions (addBomRow, updateBomRow [corrected version], deleteBomRow) ---
       // Include the functions exactly as provided in the *last correction* answer
      function addBomRow(materialId = '', netUsage = 0, wastePerc = 3) { const tbody=document.getElementById('bom-items'); const rC=tbody.rows.length; const uId=`bom-row-${Date.now()}-${rC}`; const nR=tbody.insertRow(); nR.id=uId; nR.innerHTML=`<td><div class="input-group"><select id="bom-material-${uId}" data-rowid="${uId}" onchange="updateBomRow('${uId}')"><option value="">-- Select --</option>${materialsDB.map(m => `<option value="${m.id}" ${m.id===materialId?'selected':''}>${m.id} (${m.type})</option>`).join('')}</select><span id="bom-material-${uId}-error" class="error-message"></span></div></td><td id="bom-desc-${uId}"></td><td><div class="input-group"><input type="number" id="bom-usage-${uId}" data-rowid="${uId}" value="${netUsage}" step="0.01" min="0" oninput="updateBomRow('${uId}')"><span id="bom-usage-${uId}-error" class="error-message"></span></div></td><td id="bom-unit-${uId}"></td><td><div class="input-group"><input type="number" id="bom-waste-${uId}" data-rowid="${uId}" value="${wastePerc}" step="0.1" min="0" max="100" oninput="updateBomRow('${uId}')"><span id="bom-waste-${uId}-error" class="error-message"></span></div></td><td id="bom-gross-${uId}" data-rowid="${uId}">0.000</td><td id="bom-price-${uId}" data-rowid="${uId}" class="usd">0.0000</td><td id="bom-cost-${uId}" data-rowid="${uId}" class="usd">0.0000</td><td id="bom-sust-${uId}" data-rowid="${uId}" class="text-center">0</td><td><button class="delete-button" onclick="deleteBomRow('${uId}')" aria-label="Delete BOM row">X</button></td>`; if(materialId){updateBomRow(uId);} }
      function updateBomRow(rowId) { /* CORRECTED version from previous fix */ displayError(`bom-material-${rowId}`,'');displayError(`bom-usage-${rowId}`,'');displayError(`bom-waste-${rowId}`,''); const matSel = document.getElementById(`bom-material-${rowId}`); const selId = matSel ? matSel.value : ''; const mat = findMaterial(selId); const nUse = getNumVal(`bom-usage-${rowId}`); const wPerc = getNumVal(`bom-waste-${rowId}`); let rowValid=true; if(!selId){displayError(`bom-material-${rowId}`,'Required');rowValid=false;} if(nUse<0){displayError(`bom-usage-${rowId}`,'Min 0');rowValid=false;} if(wPerc<0 || wPerc>100){displayError(`bom-waste-${rowId}`,'0-100%');rowValid=false;} let cDesc='', cUnit='', cPrice=0, cCost=0, cSust=0, cGross=0; if(mat){ cDesc=mat.description; cUnit=mat.unit; cPrice=mat.price; cSust=mat.sustScore; cGross=nUse*(1+wPerc/100); if(cUnit.includes('pcs')){ const pcs=parseInt(cUnit)||1; cCost=cGross*(cPrice/pcs); } else if(cUnit==='cone'){ cCost=nUse*cPrice; } else{ cCost=cGross*cPrice; }} setVal(`bom-desc-${rowId}`, cDesc); setVal(`bom-unit-${rowId}`, cUnit); setVal(`bom-gross-${rowId}`, cGross, 'decimal3'); setVal(`bom-price-${rowId}`, cPrice, 'decimal4'); setVal(`bom-cost-${rowId}`, cCost, 'decimal4'); setVal(`bom-sust-${rowId}`, cSust); calculateAll(); /* Trigger full calc regardless of row validity here */ }
      function deleteBomRow(rowId) { const r=document.getElementById(rowId); if(r){r.remove();calculateAll();} }

      // --- Modular Calculation Functions (calculateBomTotal etc.) ---
      // Include the full set of modular functions + updateDashboard from Optimization answer
      function calculateBomTotal() { appState.totalMaterialCostUSD=0; const bT=document.getElementById('bom-items'); bT.querySelectorAll('tr').forEach(r=>{const cC=document.getElementById(`bom-cost-${r.id}`);if(cC){appState.totalMaterialCostUSD+=parseFloat(cC.textContent)||0;}}); setVal(domCache.totalMaterialCost.id,appState.totalMaterialCostUSD,'decimal2'); domCache.totalMaterialCost.classList.add('usd'); return appState.totalMaterialCostUSD; }
      function calculateLabourAndProcess() { const cT=(getNumVal('labour-cut-time')/60)*getNumVal('labour-cut-rate'); const sT=(getNumVal('labour-sew-time')/60)*getNumVal('labour-sew-rate'); const fT=(getNumVal('labour-finish-time')/60)*getNumVal('labour-finish-rate'); const bT=(getNumVal('labour-button-time')/60)*getNumVal('labour-button-rate'); appState.totalLabourCostGBP = cT+sT+fT+bT; setVal('labour-cut-cost',cT,'currency'); setVal('labour-sew-cost',sT,'currency'); setVal('labour-finish-cost',fT,'currency'); setVal('labour-button-cost',bT,'currency'); setVal(domCache.totalLabourCost.id, appState.totalLabourCostGBP, 'currency'); appState.totalProcessCostGBP=getNumVal('process-wash-cost')+getNumVal('process-embroidery-cost'); setVal(domCache.totalProcessCost.id,appState.totalProcessCostGBP,'currency'); const totalLPC=appState.totalLabourCostGBP+appState.totalProcessCostGBP; setVal(domCache.totalLabourProcessCost.id, totalLPC, 'currency'); return { totalLPC, totalLabourCostGBP: appState.totalLabourCostGBP, totalProcessCostGBP: appState.totalProcessCostGBP}; }
      function calculateFactoryCoPAndFOB(matCostUSD, labourProcResultGBP) { const fcMC=matCostUSD; const fcLPC=labourProcResultGBP.totalLPC; const labourCostForOH=labourProcResultGBP.totalLabourCostGBP; setVal(domCache.fcMaterialCost.id,fcMC,'decimal2');domCache.fcMaterialCost.classList.add('usd'); setVal(domCache.fcLabourCost.id,labourCostForOH,'decimal2');domCache.fcLabourCost.classList.add('usd'); setVal(domCache.fcProcessCost.id,labourProcResultGBP.totalProcessCostGBP,'decimal2');domCache.fcProcessCost.classList.add('usd'); const oP=getNumVal('factory-overhead-perc')/100; const oV=labourCostForOH*oP; setVal(domCache.fcOverheadValue.id,oV,'decimal2');domCache.fcOverheadValue.classList.add('usd'); appState.factoryCoP_USD=fcMC+fcLPC+oV; setVal(domCache.fcCop.id,appState.factoryCoP_USD,'decimal2');domCache.fcCop.classList.add('usd'); const rP=getNumVal('factory-rejects-perc')/100; const rV=appState.factoryCoP_USD*rP; setVal(domCache.fcRejectsValue.id,rV,'decimal2');domCache.fcRejectsValue.classList.add('usd'); const pP=getNumVal('factory-profit-perc')/100; const cP=getNumVal('factory-commission-perc')/100; const fobD=1-pP-cP; appState.factoryFOB_USD=fobD>0?(appState.factoryCoP_USD+rV)/fobD:0; setVal(domCache.fcFobPrice.id,appState.factoryFOB_USD,'decimal2');domCache.fcFobPrice.classList.add('usd'); const pV=appState.factoryFOB_USD*pP; const cV=appState.factoryFOB_USD*cP; setVal(domCache.fcProfitValue.id,pV,'decimal2');domCache.fcProfitValue.classList.add('usd'); setVal(domCache.fcCommissionValue.id,cV,'decimal2');domCache.fcCommissionValue.classList.add('usd'); return { factoryFOB:appState.factoryFOB_USD, factoryCoP:appState.factoryCoP_USD, fcMaterialCost:fcMC, labourCostForOverhead:labourCostForOH, totalProcessCost:labourProcResultGBP.totalProcessCostGBP, overheadValue:oV, profitValue:pV, commissionValue:cV, rejectsValue:rV}; }
      function calculateLandedCost(fobUSD) { setVal(domCache.liFobPrice.id,fobUSD,'decimal2');domCache.liFobPrice.classList.add('usd'); const sC=getNumVal('li-shipping-cost'); const iC=getNumVal('li-insurance-cost'); const ciP=fobUSD+sC+iC; setVal(domCache.liCifPrice.id,ciP,'decimal2');domCache.liCifPrice.classList.add('usd'); const dP=getNumVal('li-import-duty-perc')/100; const dV=fobUSD*dP; setVal(domCache.liDutyValue.id,dV,'decimal2');domCache.liDutyValue.classList.add('usd'); const clC=getNumVal('li-clearance-cost'); const tC=getNumVal('li-transport-cost'); const waP=getNumVal('li-warehouse-admin-perc')/100; const waV=fobUSD*waP; setVal(domCache.liWarehouseAdminValue.id,waV,'decimal2');domCache.liWarehouseAdminValue.classList.add('usd'); const tPC=fobUSD+sC+iC+dV+clC+tC+waV; setVal(domCache.liTotalPreConversion.id,tPC,'decimal2');domCache.liTotalPreConversion.classList.add('usd'); const eR=getNumVal(domCache.exchangeRateInput.id); appState.landedCostGBP=eR!==0?tPC/eR:0; setVal(domCache.liLcpGbp.id,appState.landedCostGBP,'currency'); return appState.landedCostGBP;}
      function calculateRetailPricing(lcpGBP) { setVal(domCache.prLcp.id,lcpGBP,'currency'); const rmP=getNumVal('pr-retail-margin-perc')/100; const crEV=rmP<1?lcpGBP/(1-rmP):lcpGBP; setVal(domCache.prCalcRetailExVat.id,crEV,'currency'); appState.retailExVatGBP=getNumVal('pr-chosen-retail-ex-vat'); const vP=getNumVal('pr-vat-perc')/100; const vA=appState.retailExVatGBP*vP; setVal(domCache.prVatAmount.id,vA,'currency'); appState.retailIncVatGBP=appState.retailExVatGBP+vA; setVal(domCache.prFinalRetailIncVat.id,appState.retailIncVatGBP,'currency'); const cMu=lcpGBP!==0?((appState.retailExVatGBP-lcpGBP)/lcpGBP)*100:0; const cMg=appState.retailExVatGBP!==0?((appState.retailExVatGBP-lcpGBP)/appState.retailExVatGBP)*100:0; setVal(domCache.prCalcMarkup.id,cMu,'percentage'); setVal(domCache.prCalcMargin.id,cMg,'percentage'); return { retailExVat:appState.retailExVatGBP, retailIncVat:appState.retailIncVatGBP, calcMargin:cMg }; }
      function calculateSustainabilityScore() { let tssp=0, tsw=0; document.getElementById('bom-items').querySelectorAll('tr').forEach(r=>{const sC=document.getElementById(`bom-sust-${r.id}`);const cC=document.getElementById(`bom-cost-${r.id}`);if(sC&&cC){const s=parseFloat(sC.textContent)||0;const w=parseFloat(cC.textContent)||0;if(s>0&&w>0){tssp+=s*w;tsw+=w;}}}); const mS=tsw>0?tssp/tsw:0; setVal(domCache.susMaterialScore.id,mS,'decimal1'); const sc=[mS,getSelectedVal('sus-factory-ethics'),getSelectedVal('sus-labour-wage'),getSelectedVal('sus-process-impact'),getSelectedVal('sus-logistics-impact'),getSelectedVal('sus-circularity')]; const vS=sc.filter(s=>typeof s==='number'&&s>=1&&s<=5); appState.sustainabilityScore=vS.length>0?vS.reduce((a,b)=>a+b,0)/vS.length:0; setVal(domCache.susOverallScore.id,appState.sustainabilityScore,'decimal1'); return appState.sustainabilityScore;}
      function calculateBusinessAnalysis(lcpGBP, rExVatGBP) { setVal(domCache.baLcp.id,lcpGBP,'currency'); setVal(domCache.baRetailExVat.id,rExVatGBP,'currency'); const conM=rExVatGBP-lcpGBP; setVal(domCache.baContributionMargin.id,conM,'currency'); const fC=getNumVal('ba-fixed-costs'); appState.breakEvenUnits=conM>0?Math.ceil(fC/conM):0; const bER=appState.breakEvenUnits*rExVatGBP; setVal(domCache.baBreakEvenUnits.id,appState.breakEvenUnits,'integer'); setVal(domCache.baBreakEvenRevenue.id,bER,'currency'); return appState.breakEvenUnits;}
      function updateDashboard(calcs) { setVal(domCache.dashProductName.id, getTxtVal('product-name')); setVal(domCache.dashTargetRetail.id, getNumVal('target-retail-price'),'currency'); setVal(domCache.dashCalcRetail.id, calcs.retail.retailIncVat,'currency'); setVal(domCache.dashLcp.id, calcs.landedCost,'currency'); const eR=calcs.exchangeRate; const fobGBP=eR!==0?calcs.factory.factoryFOB/eR:0; setVal(domCache.dashFob.id, fobGBP,'currency'); const fcMG=eR!==0?calcs.factory.fcMaterialCost/eR:0; const fcLG=eR!==0?calcs.factory.labourCostForOverhead/eR:0; const fcPG=eR!==0?calcs.factory.totalProcessCost/eR:0; const ovG=eR!==0?calcs.factory.overheadValue/eR:0; const pVG=eR!==0?calcs.factory.profitValue/eR:0; const cVG=eR!==0?calcs.factory.commissionValue/eR:0; const rVG=eR!==0?calcs.factory.rejectsValue/eR:0; setVal(domCache.dashMaterialCost.id,fcMG,'currency'); setVal(domCache.dashLabourCost.id,fcLG,'currency'); setVal(domCache.dashMargin.id, calcs.retail.calcMargin,'percentage'); setVal(domCache.dashSustainability.id, calcs.sustainabilityScore,'decimal1'); setVal(domCache.dashBreakEven.id, calcs.breakEvenUnits,'integer'); const fobGC=fobGBP>0?fobGBP:1; setVal(domCache.dashBreakdownMaterial.id, (fcMG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownLabour.id, (fcLG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownProcess.id, (fcPG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownOverhead.id, (ovG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownProfit.id, (pVG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownCommission.id, (cVG/fobGC*100),'percentage'); setVal(domCache.dashBreakdownRejects.id, (rVG/fobGC*100),'percentage'); }


      // --- calculateAll Orchestrator ---
      function calculateAll() {
          if (!validateInputs()) { console.warn("Calc paused"); return; }
          console.log("Calculating Modular...");
          clearAllErrors(); // Clear errors if validation passes
          const results={};
          results.bomMaterialCost = calculateBomTotal(); // USD
          results.labourProcess = calculateLabourAndProcess(); // £ results {totalLPC, totalLabourCostGBP, totalProcessCostGBP}
          results.factory = calculateFactoryCoPAndFOB(results.bomMaterialCost, results.labourProcess); // USD results object
          results.landedCost = calculateLandedCost(results.factory.factoryFOB); // £ result
          results.retail = calculateRetailPricing(results.landedCost); // £ results object {retailExVat, retailIncVat, calcMargin}
          results.sustainabilityScore = calculateSustainabilityScore();
          results.breakEvenUnits = calculateBusinessAnalysis(results.landedCost, results.retail.retailExVat);
          results.exchangeRate = getNumVal(domCache.exchangeRateInput.id); // Include exchange rate for dashboard conversions
          updateDashboard(results); // Update the main dashboard last
      }

       // --- Save/Load/Report/Modal/Navigation/Init Functions ---
       // (Include the full set from the V2.1 response, no major changes needed here)
        function saveData(){const d={};document.querySelectorAll('input[id]:not([type=button]):not([type=submit]), select[id]').forEach(el=>{if(!el.closest('.modal')&&!el.closest('#report-bom-table')){d[el.id]=(el.type==='checkbox'||el.type==='radio')?el.checked:el.value;}}); /* Note: STILL does not reliably save BOM rows structure */ try{localStorage.setItem(SAVE_KEY,JSON.stringify(d)); setSaveLoadStatus('Progress Saved!','green');console.log("Saved.");} catch(e){console.error("Err saving:",e);setSaveLoadStatus('Error saving!','red');}}
        function loadData(){const s=localStorage.getItem(SAVE_KEY); let loaded=false; if(s){try{const d=JSON.parse(s); for(const id in d){const el=domCache[id] || document.getElementById(id); if(el && !el.closest('.bom-table')){ if(el.type==='checkbox'||el.type==='radio'){el.checked=d[id];} else {el.value=d[id];}}} loaded=true; setSaveLoadStatus('Progress Loaded!','green'); console.log("Loaded non-BOM.");} catch(e){console.error("Err loading:",e);setSaveLoadStatus('Error loading/parsing!','red');localStorage.removeItem(SAVE_KEY);}} else{setSaveLoadStatus('No saved data found.','orange');} calculateAll();}
        function setSaveLoadStatus(msg,col){const sE=document.getElementById('saveLoadStatus');sE.textContent=msg;sE.style.color=col;setTimeout(()=>{sE.textContent='';},3500);}
        function generateReport() { if(appState.calculationPaused){alert("Please correct input errors before generating report.");return;} document.getElementById('report-product-details').innerHTML = `<strong>Name:</strong> ${getTxtVal('product-name')} | <strong>Season:</strong> ${getTxtVal('season')} | <strong>Target Qty:</strong> ${getNumVal('target-quantity')}`; let pricesHtml = `<strong>LCP:</strong> ${localSymbol}${appState.landedCostGBP.toFixed(2)} | <strong>Retail Ex VAT:</strong> ${localSymbol}${appState.retailExVatGBP.toFixed(2)} | <strong>Retail Inc VAT:</strong> ${localSymbol}${appState.retailIncVatGBP.toFixed(2)} | <strong>Margin:</strong> ${domCache.prCalcMargin.textContent}%`; document.getElementById('report-key-prices').innerHTML = pricesHtml; let breakdownHtml = `Materials: ${domCache.dashBreakdownMaterial.textContent}% | Labour: ${domCache.dashBreakdownLabour.textContent}% | Processes: ${domCache.dashBreakdownProcess.textContent}% | Overheads: ${domCache.dashBreakdownOverhead.textContent}% | Profit: ${domCache.dashBreakdownProfit.textContent}% | Commission: ${domCache.dashBreakdownCommission.textContent}% | Rejects: ${domCache.dashBreakdownRejects.textContent}%`; document.getElementById('report-fob-breakdown').innerHTML = breakdownHtml; const rBT = document.getElementById('report-bom-table').querySelector('tbody'); const rBF = document.getElementById('report-bom-table').querySelector('tfoot'); rBT.innerHTML = document.getElementById('bom-items').innerHTML; rBT.querySelectorAll('.input-group, .delete-button, .error-message').forEach(el=>el.remove()); rBT.querySelectorAll('select, input').forEach(el=>{const val=el.value||el.textContent; const pTd=el.closest('td'); if(pTd){ pTd.innerHTML=''; pTd.textContent = el.tagName === 'INPUT' ? getNumVal(el.id) : val ; } }); rBT.querySelectorAll('td:last-child').forEach(td=>td.style.display='none'); /* Hide actions col */ const rBH = document.getElementById('report-bom-table').querySelector('thead'); if(rBH) rBH.querySelector('tr th:last-child').style.display='none'; rBF.innerHTML = `<tr><td colspan="7" style="text-align:right;font-weight:bold;">TOTAL Material Cost/Gmt:</td><td style="font-weight:bold;" class="usd">${appState.totalMaterialCostUSD.toFixed(2)}</td><td></td></tr>`; rBF.querySelector('tr td:last-child').style.display='none'; let susHtml=`<strong>Overall:</strong> ${appState.sustainabilityScore.toFixed(1)}/5 | (Mats: ${getNumVal('sus-material-score').toFixed(1)}, Eth: ${getSelectedVal('sus-factory-ethics')}, Wage: ${getSelectedVal('sus-labour-wage')}, Proc: ${getSelectedVal('sus-process-impact')}, Log: ${getSelectedVal('sus-logistics-impact')}, Circ: ${getSelectedVal('sus-circularity')})`; document.getElementById('report-sustainability').innerHTML=susHtml; let bizHtml=`<strong>Break-Even:</strong> ${appState.breakEvenUnits} U/Month | <strong>Revenue:</strong> ${localSymbol}${domCache.baBreakEvenRevenue.textContent}/Month | (Fixed Costs: ${localSymbol}${getNumVal('ba-fixed-costs')})`; document.getElementById('report-business').innerHTML = bizHtml; } // Removed openModal from here
        function printReport(){window.print();}
        function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); const sP=document.getElementById(id); if(sP)sP.classList.add('active'); document.querySelectorAll('#main-nav button').forEach(b=>{b.classList.remove('active'); const tP=b.getAttribute('onclick')?.match(/showPage\('([^']+)'\)/)?.[1]; if(tP===id){b.classList.add('active');}}); window.scrollTo(0,0); }
        function openModal(id){const m=document.getElementById(id); if(m){ if(id==='report-modal'){ if(appState.calculationPaused){ alert("Cannot view report due to input errors. Please correct first."); return; } generateReport(); } m.style.display='block';}}
        function closeModal(id){const m=document.getElementById(id); if(m)m.style.display='none'; }
        window.onclick = function(e){document.querySelectorAll('.modal').forEach(m=>{if(e.target == m){closeModal(m.id);}});}

        window.onload = () => {
           cacheDOMElements(); // Cache on load
           let loaded = false;
           const s = localStorage.getItem(SAVE_KEY);
           if(s){try{const d=JSON.parse(s); for(const id in d){const el=domCache[id] || document.getElementById(id); if(el && !el.closest('.bom-table')){ el.value=d[id];}} loaded=true;} catch(e){localStorage.removeItem(SAVE_KEY);}}
           addBomRow('FAB001',1.35,3); addBomRow('FAB002',0.35,3); addBomRow('TRM001',6,5); addBomRow('TRM002',6,5); addBomRow('LBL001',1,10); addBomRow('LBL002',1,10); addBomRow('LBL003',1,10); addBomRow('PKG002',1,10); addBomRow('PKG001',1,10); addBomRow('PKG003',1,5); addBomRow('THR001',0.1,5);
           if(loaded){setSaveLoadStatus('Progress Loaded!', 'green'); console.log("Non-BOM loaded.");}

           showPage('dashboard');
           calculateAll(); // Initial calc

           document.querySelectorAll('input[id], select[id]').forEach(el=>{ if(!el.closest('.bom-table') && !el.id.includes('save') && !el.id.includes('load')){el.addEventListener('input', calculateAll); el.addEventListener('change', calculateAll); }});
           document.getElementById('saveButton').addEventListener('click', saveData);
           document.getElementById('loadButton').addEventListener('click', ()=>{ if(confirm('Loading will overwrite non-BOM inputs. Continue?')){loadData();} });
       };

</script>

</body>
</html>
